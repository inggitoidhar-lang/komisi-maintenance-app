<!DOCTYPE html>
<html>
<head>
  <base target="_top" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#00a0c6;
      --text:#0b1220;
      --muted:#64748b;

      --bg1:#0b2a57;
      --bg2:#0b3b8a;

      --shadow1: 0 30px 80px rgba(0,0,0,.28);
      --shadow2: 0 18px 40px rgba(2,6,23,.12);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:"Manrope", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 520px at 30% 25%, rgba(42,167,255,.45), transparent 55%),
        radial-gradient(700px 520px at 70% 75%, rgba(0,160,198,.35), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }

    .page{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 28px 16px;
    }

    .wrap{
      width: 100%;
      max-width: 640px;
    }

    .loginCard{
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 28px;
      padding: 18px;
      box-shadow: var(--shadow1);
      backdrop-filter: blur(14px);
    }

    .loginBox{
      background: rgba(255,255,255,.96);
      border-radius: 24px;
      border: 1px solid rgba(15,23,42,.10);
      padding: 20px;
      box-shadow: var(--shadow2);
    }

    .loginBrand{
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      gap:10px;
      margin-bottom: 16px;
    }

    /* CHANGED: logo dibesarin */
    .loginLogo{
      height: 140px;
      width:auto;
      display:block;
    }

    /* CHANGED: judul & sub judul dihapus, tapi class tetap ada biar tidak ganggu layout */
    .loginTitle{ display:none; }
    .loginSub{ display:none; }

    .lLabelRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }

    .lLabel{
      display:flex;
      align-items:center;
      gap:6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing:.2px;
    }

    .infoWrap{
      position: relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid rgba(0,160,198,.35);
      background: rgba(0,160,198,.10);
      cursor: help;
      user-select:none;
      flex: 0 0 auto;
      color: rgba(0,160,198,.95);
    }

    .infoWrap svg{
      width: 14px;
      height: 14px;
      display:block;
      color: rgba(0,160,198,.95);
    }

    .tooltip{
      position:absolute;
      right: 0;
      top: calc(100% + 10px);
      width: min(360px, 78vw);
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(15,23,42,.95);
      color: #fff;
      font-size: 12px;
      font-weight: 800;
      line-height: 1.35;
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
      opacity: 0;
      transform: translateY(-6px);
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease;
      z-index: 50;
    }

    .tooltip:before{
      content:"";
      position:absolute;
      top:-7px;
      right: 10px;
      border-width: 0 8px 8px 8px;
      border-style: solid;
      border-color: transparent transparent rgba(15,23,42,.95) transparent;
    }

    .infoWrap:hover .tooltip,
    .infoWrap:focus-within .tooltip{
      opacity: 1;
      transform: translateY(0);
    }

    .row{
      display:flex;
      gap:10px;
      align-items:stretch;
      flex-wrap:wrap;
    }

    .lInput{
      width:100%;
      height:60px;
      padding: 14px 14px;
      border: 1px solid rgba(15,23,42,.14);
      border-radius: 18px;
      font-size: 16px;
      outline:none;
      background:#fff;
      font-family: inherit;
      font-weight: 800;
    }

    .lInput:focus{
      border-color: rgba(0,160,198,.75);
      box-shadow: 0 0 0 6px rgba(0,160,198,.12);
    }

    .lBtn{
      height:60px;
      padding: 0 16px;
      border-radius: 18px;
      border: 1px solid transparent;
      font-weight: 900;
      cursor:pointer;
      font-size: 15px;
      font-family: inherit;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
      gap:10px;
      background: linear-gradient(135deg, rgba(0,160,198,1), rgba(0,160,198,.85));
      color:#fff;
      box-shadow: 0 14px 26px rgba(0,160,198,.20);
      flex: 1;
    }
    .lBtn svg{ width:18px; height:18px; display:block; }
    .lBtn[disabled]{ opacity:.6; cursor:not-allowed; }

    .btnGhost{
      height:60px;
      border-radius:18px;
      background:#fff;
      border:1px solid rgba(15,23,42,.14);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
      padding: 0 16px;
      white-space:nowrap;
    }
    .btnGhost[disabled]{ opacity:.55; cursor:not-allowed; }

    .rememberInline{
      display:inline-flex;
      align-items:center;
      gap:10px;
      height: 60px;
      padding: 0 6px;
      user-select:none;
      cursor:pointer;
      font-size: 13px;
      font-weight: 900;
      color: rgba(11,18,32,.80);
      white-space:nowrap;
    }

    .rememberInline input{
      appearance:none;
      -webkit-appearance:none;
      width: 22px;
      height: 22px;
      border-radius: 8px;
      border: 2px solid rgba(15,23,42,.25);
      background: #fff;
      display:inline-grid;
      place-content:center;
      margin:0;
      cursor:pointer;
      transition: border-color .15s ease, background .15s ease, transform .05s ease;
    }
    .rememberInline input:active{ transform: translateY(1px); }
    .rememberInline input:checked{
      border-color: rgba(0,160,198,.9);
      background: rgba(0,160,198,.95);
    }
    .rememberInline input:checked::after{
      content:"";
      width: 10px;
      height: 6px;
      border-left: 3px solid #fff;
      border-bottom: 3px solid #fff;
      transform: rotate(-45deg);
      margin-top: -1px;
    }

    /* ===== Premium OTP Boxes ===== */
    .otpGrid{
      width: 100%;
      display:flex;
      gap:10px;
      justify-content:space-between;
      margin-top: 2px;
    }

    .otpBox{
      flex: 1 1 0;
      min-width: 44px;
      height: 60px;
      border-radius: 18px;
      border: 1px solid rgba(15,23,42,.14);
      background:#fff;
      font-family: inherit;
      font-weight: 900;
      font-size: 20px;
      text-align:center;
      outline:none;
      transition: border-color .15s ease, box-shadow .15s ease;
    }

    .otpBox:focus{
      border-color: rgba(0,160,198,.75);
      box-shadow: 0 0 0 6px rgba(0,160,198,.12);
    }

    .otpHint{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(11,18,32,.60);
      font-weight: 800;
    }

    .hiddenOtp{
      position:absolute;
      left:-9999px;
      width:1px;
      height:1px;
      opacity:0;
    }

    .loginMsg{
      margin-top:10px;
      color:#b00020;
      font-size: 13px;
      font-weight: 900;
      min-height: 18px;
    }

    .copyright{
      text-align:center;
      margin:16px 0 0 0;
      font-size: 11px;
      font-weight: 800;
      color: rgba(255,255,255,.75);
      letter-spacing:.2px;
    }

    @media (max-width: 420px){
      /* CHANGED: responsive logo */
      .loginLogo{ height: 120px; }
      .tooltip{ width: 80vw; }
      .otpGrid{ gap:8px; }
      .otpBox{ min-width: 40px; }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="wrap">
      <div class="loginCard">
        <div class="loginBox">
          <div class="loginBrand">
            <img class="loginLogo" src="https://res.cloudinary.com/dkps3vy8m/image/upload/v1770658191/5_totgo8.png" alt="Jendela360" />
            <div class="loginTitle">Pemeriksa Komisi</div>
            <div class="loginSub">Divisi Maintenance</div>
          </div>

          <div id="stepEmail">
            <div class="lLabelRow">
              <div class="lLabel">
                Email
                <div class="infoWrap" tabindex="0" aria-label="Info email">
                  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M12 17v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M12 7.5h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                    <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  <div class="tooltip">
                    Masukan email sesuai yang didaftarkan ke Tim HCGA. Pastikan masuk hanya untuk memeriksa komisi pribadi, bukan orang lain!
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <input id="emailInputLogin" class="lInput" placeholder="contoh: nama@gmail.com" inputmode="email" />
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="lBtn" id="btnRequestOtp" onclick="requestOtp(false)">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M14 7h6v10h-6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M10 12h10" stroke="white" stroke-width="2" stroke-linecap="round"/>
                  <path d="M10 12l2.5-2.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M10 12l2.5 2.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M4 4h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
                  <path d="M4 20h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
                  <path d="M4 4v16" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Masuk
              </button>

              <label class="rememberInline" for="rememberMe">
                <input id="rememberMe" type="checkbox" />
                Ingat Saya
              </label>
            </div>
          </div>

          <div id="stepOtp" style="display:none;">
            <div class="lLabel">Kode OTP</div>

            <div class="otpGrid" id="otpGrid" aria-label="Input OTP 6 digit">
              <input class="otpBox" inputmode="numeric" maxlength="1" data-idx="0" />
              <input class="otpBox" inputmode="numeric" maxlength="1" data-idx="1" />
              <input class="otpBox" inputmode="numeric" maxlength="1" data-idx="2" />
              <input class="otpBox" inputmode="numeric" maxlength="1" data-idx="3" />
              <input class="otpBox" inputmode="numeric" maxlength="1" data-idx="4" />
              <input class="otpBox" inputmode="numeric" maxlength="1" data-idx="5" />
            </div>

            <input id="otpInput" class="hiddenOtp" />

            <div class="otpHint">Tip: kamu bisa paste 6 digit sekaligus.</div>

            <div class="row" style="margin-top:10px;">
              <button class="lBtn" id="btnVerifyOtp" onclick="verifyOtp()">
                <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M20 7 10.5 16.5 4 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Verifikasi
              </button>
              <button class="btnGhost" id="btnResend" onclick="requestOtp(true)">Kirim Ulang</button>
              <button class="btnGhost" onclick="backToEmail()">Ganti Email</button>
            </div>
          </div>

          <div class="loginMsg" id="loginMsg"></div>
        </div>
      </div>

      <div class="copyright">Â© Internal Tools by HCGA Jendela360 (IIA)</div>
    </div>
  </div>

  <script>
    const APP_URL = "<?= appUrl ?>";
    const PREFILL_EMAIL = "<?= prefillEmail ?>";

    const KEY_EMAIL = "mitraEmail";
    const KEY_REMEMBER_TOKEN = "rememberToken";

    let resendTimer = null;
    let resendRemain = 0;
    let resendBaseText = "Kirim Ulang";

    function safeParse(m){
      if (typeof m === "object" && m) return m;
      try { return JSON.parse(m); } catch(e){ return null; }
    }
    function setLoginMsg(t){ document.getElementById("loginMsg").innerText = t || ""; }

    function showEmailStep(){
      document.getElementById("stepEmail").style.display = "";
      document.getElementById("stepOtp").style.display = "none";
      clearOtpBoxes();
      stopResendCountdown(true);
    }
    function showOtpStep(){
      document.getElementById("stepEmail").style.display = "none";
      document.getElementById("stepOtp").style.display = "";
      setTimeout(()=>focusOtp(0), 120);
    }
    function backToEmail(){
      setLoginMsg("");
      showEmailStep();
    }

    function goDashboard(email){
      const e = String(email || "").trim().toLowerCase();
      if (!e) return;
      const url = APP_URL + "?page=dashboard&email=" + encodeURIComponent(e);
      window.location.assign(url);
    }

    function getCurrentEmail(){
      const email = (document.getElementById("emailInputLogin").value || "").trim().toLowerCase();
      return email;
    }

    function setButtonsSending(isSending, isResend){
      if (!isResend){
        const b = document.getElementById("btnRequestOtp");
        if (b) b.disabled = !!isSending;
      } else {
        const r = document.getElementById("btnResend");
        if (r) r.disabled = !!isSending || resendRemain > 0;
      }
    }

    function startResendCountdown(seconds){
      const btn = document.getElementById("btnResend");
      if (!btn) return;

      stopResendCountdown(false);
      resendRemain = Math.max(0, parseInt(seconds, 10) || 0);
      resendBaseText = resendBaseText || btn.textContent || "Kirim Ulang";

      if (resendRemain <= 0){
        btn.textContent = resendBaseText;
        btn.disabled = false;
        return;
      }

      btn.disabled = true;
      btn.textContent = `${resendBaseText} (${resendRemain})`;

      resendTimer = setInterval(() => {
        resendRemain = Math.max(0, resendRemain - 1);
        if (resendRemain <= 0){
          stopResendCountdown(false);
          btn.textContent = resendBaseText;
          btn.disabled = false;
        } else {
          btn.textContent = `${resendBaseText} (${resendRemain})`;
        }
      }, 1000);
    }

    function stopResendCountdown(resetText){
      const btn = document.getElementById("btnResend");
      if (resendTimer){
        clearInterval(resendTimer);
        resendTimer = null;
      }
      resendRemain = 0;
      if (btn){
        if (resetText) btn.textContent = resendBaseText || "Kirim Ulang";
        btn.disabled = false;
      }
    }

    function requestOtp(isResend){
      const email = getCurrentEmail();
      if (!email){
        setLoginMsg("Isi email dulu ya.");
        return;
      }

      setLoginMsg("");
      setButtonsSending(true, !!isResend);

      google.script.run
        .withSuccessHandler((json) => {
          setButtonsSending(false, !!isResend);
          const res = safeParse(json);
          if (!res){ setLoginMsg("Response server tidak valid."); return; }
          if (!res.ok){ setLoginMsg(res.message || "Gagal kirim OTP."); return; }

          sessionStorage.setItem(KEY_EMAIL, email);

          clearOtpBoxes();
          setLoginMsg(res.message || "OTP terkirim.");
          showOtpStep();

          const cd = (res.cooldownSeconds != null) ? res.cooldownSeconds : 60;
          startResendCountdown(cd);
        })
        .withFailureHandler((err) => {
          setButtonsSending(false, !!isResend);
          setLoginMsg("Error: " + (err && err.message ? err.message : err));
        })
        .requestOtp(email);
    }

    function verifyOtp(){
      const email = (sessionStorage.getItem(KEY_EMAIL) || "").trim().toLowerCase();
      if (!email){
        setLoginMsg("Email belum ada. Balik ke langkah email.");
        showEmailStep();
        return;
      }

      const otp = (document.getElementById("otpInput").value || "").trim();
      const remember = document.getElementById("rememberMe").checked;

      if (otp.length !== 6){
        setLoginMsg("OTP harus 6 digit.");
        return;
      }

      document.getElementById("btnVerifyOtp").disabled = true;
      setLoginMsg("");

      google.script.run
        .withSuccessHandler((json) => {
          document.getElementById("btnVerifyOtp").disabled = false;
          const res = safeParse(json);
          if (!res){ setLoginMsg("Response server tidak valid."); return; }
          if (!res.ok){ setLoginMsg(res.message || "OTP salah."); return; }

          sessionStorage.setItem(KEY_EMAIL, res.email || email);

          if (remember && res.token) localStorage.setItem(KEY_REMEMBER_TOKEN, res.token);
          else localStorage.removeItem(KEY_REMEMBER_TOKEN);

          goDashboard(res.email || email);
        })
        .withFailureHandler((err) => {
          document.getElementById("btnVerifyOtp").disabled = false;
          setLoginMsg("Error: " + (err && err.message ? err.message : err));
        })
        .verifyOtp(email, otp, remember);
    }

    function tryAutoLogin(){
      if (PREFILL_EMAIL){
        sessionStorage.setItem(KEY_EMAIL, String(PREFILL_EMAIL).trim().toLowerCase());
        goDashboard(PREFILL_EMAIL);
        return true;
      }

      const token = (localStorage.getItem(KEY_REMEMBER_TOKEN) || "").trim();
      if (!token) return false;

      google.script.run
        .withSuccessHandler((json) => {
          const res = safeParse(json);
          if (!res || !res.ok || !res.email){
            localStorage.removeItem(KEY_REMEMBER_TOKEN);
            return;
          }
          sessionStorage.setItem(KEY_EMAIL, res.email);
          goDashboard(res.email);
        })
        .withFailureHandler(() => {})
        .validateRememberToken(token);

      return true;
    }

    function otpBoxes(){
      return Array.from(document.querySelectorAll("#otpGrid .otpBox"));
    }

    function clearOtpBoxes(){
      otpBoxes().forEach(b => b.value = "");
      document.getElementById("otpInput").value = "";
    }

    function focusOtp(i){
      const boxes = otpBoxes();
      const b = boxes[i];
      if (b) b.focus();
    }

    function syncOtpToHidden(){
      const boxes = otpBoxes();
      const v = boxes.map(b => (b.value || "").replace(/\D/g,"")).join("").slice(0,6);
      document.getElementById("otpInput").value = v;
    }

    function fillFromString(str){
      const digits = String(str || "").replace(/\D/g,"").slice(0,6).split("");
      const boxes = otpBoxes();
      boxes.forEach((b, i) => b.value = digits[i] || "");
      syncOtpToHidden();
      const next = Math.min(digits.length, 5);
      focusOtp(next);
    }

    function initOtpEvents(){
      const boxes = otpBoxes();

      boxes.forEach((box, idx) => {
        box.addEventListener("input", () => {
          const val = (box.value || "").replace(/\D/g,"");
          box.value = val.slice(-1);

          syncOtpToHidden();

          if (box.value && idx < boxes.length - 1){
            boxes[idx + 1].focus();
          }
        });

        box.addEventListener("keydown", (e) => {
          if (e.key === "Backspace"){
            if (!box.value && idx > 0){
              boxes[idx - 1].focus();
              boxes[idx - 1].value = "";
              syncOtpToHidden();
              e.preventDefault();
            }
          } else if (e.key === "ArrowLeft" && idx > 0){
            boxes[idx - 1].focus();
            e.preventDefault();
          } else if (e.key === "ArrowRight" && idx < boxes.length - 1){
            boxes[idx + 1].focus();
            e.preventDefault();
          } else if (e.key === "Enter"){
            verifyOtp();
          }
        });

        box.addEventListener("paste", (e) => {
          e.preventDefault();
          const text = (e.clipboardData || window.clipboardData).getData("text");
          fillFromString(text);
        });
      });
    }

    (function init(){
      initOtpEvents();

      if (!tryAutoLogin()){
        showEmailStep();
        const el = document.getElementById("emailInputLogin");
        if (PREFILL_EMAIL) el.value = String(PREFILL_EMAIL).trim().toLowerCase();
        setTimeout(()=>el.focus(), 120);
      }
    })();
  </script>
</body>
</html>
