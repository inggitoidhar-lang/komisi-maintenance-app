<!DOCTYPE html>
<html>
<head>
  <base target="_top" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#00a0c6; --text:#0b1220; --muted:#64748b;
      --radius:18px; --bg1:#0b2a57; --bg2:#0b3b8a; --soft:#f7fafc;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:"Manrope", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text); background:#fff; }
    .wrap{ max-width: 1180px; margin:0 auto; padding:18px; }

    .top{
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      border-radius: var(--radius);
      padding: 14px 16px;
      color:#fff;
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .leftTop{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .logo{ height:30px; }
    .title{ font-weight:900; }
    .sub{ color: rgba(255,255,255,.75); font-weight:800; font-size:12px; margin-top:2px; }

    .btnSmall{
      height:44px; padding: 0 14px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.12);
      cursor:pointer; font-weight: 900; font-size: 14px; color:#fff;
    }
    .btnSmall:hover{ background: rgba(255,255,255,.18); }

    .card{ margin-top:12px; border:1px solid rgba(15,23,42,.10); border-radius: var(--radius); padding:16px; box-shadow: 0 10px 24px rgba(2, 6, 23, .08); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    .field{ flex:1; min-width: 200px; }
    label{ display:block; font-size:12px; color:var(--muted); font-weight:900; margin-bottom:6px; }
    input{
      width:100%; height:48px; border-radius: 14px; border:1px solid rgba(15,23,42,.12);
      padding: 10px 12px; font-weight:800; font-family:inherit;
    }
    .btn{
      height:48px; border-radius:14px; border:1px solid rgba(15,23,42,.14);
      background:#fff; font-weight:900; cursor:pointer; padding: 0 12px;
    }
    .btn.primary{
      border-color: transparent;
      background: linear-gradient(135deg, rgba(0,160,198,1), rgba(0,160,198,.85));
      color:#fff;
    }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

    table{ width:100%; border-collapse: collapse; font-size: 12px; }
    th, td{ padding: 10px 10px; border-bottom:1px solid rgba(15,23,42,.08); text-align:left; white-space:nowrap; }
    th{ color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:.2px; position:sticky; top:0; background:#fff; }
    .wrapTable{ max-height: 520px; overflow:auto; border-radius: 14px; border:1px solid rgba(15,23,42,.08); }
    tr.me td{ background: rgba(0,160,198,.10); font-weight:900; }
    .msg{ margin-top:10px; color:#b00020; font-weight:900; min-height:18px; }
    .note{ font-size:12px; color:var(--muted); font-weight:800; margin-top:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="leftTop">
        <img class="logo" src="<?= logoWhiteUrl ?>" alt="Jendela360">
        <div>
          <div class="title">Ranking</div>
          <div class="sub">Full page peringkat (ikut filter tanggal)</div>
        </div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btnSmall" onclick="goPage('dashboard')">Beranda</button>
        <button class="btnSmall" onclick="logout()">Keluar</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:900;">Mitra: <span id="namaMitra">-</span> <span class="note" id="divisiText"></span></div>

      <div class="row" style="margin-top:12px;">
        <div class="field">
          <label>Tanggal Awal</label>
          <input type="date" id="dateFrom">
        </div>
        <div class="field">
          <label>Tanggal Akhir</label>
          <input type="date" id="dateTo">
        </div>
        <div class="field" style="min-width:160px;">
          <label>&nbsp;</label>
          <button class="btn" onclick="resetFilter()">Reset</button>
        </div>
        <div class="field" style="min-width:160px;">
          <label>&nbsp;</label>
          <button class="btn primary" onclick="applyFilter()">Terapkan</button>
        </div>
      </div>

      <div class="msg" id="msg"></div>

      <div class="grid">
        <div>
          <div style="font-weight:900; margin-bottom:8px;">Antar Divisi</div>
          <div class="wrapTable">
            <table>
              <thead>
                <tr><th>Rank</th><th>Nama</th><th>Divisi</th><th>Total</th><th>SPK</th></tr>
              </thead>
              <tbody id="tbAcross"><tr><td colspan="5">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>

        <div>
          <div style="font-weight:900; margin-bottom:8px;">Dalam Divisi</div>
          <div class="wrapTable">
            <table>
              <thead>
                <tr><th>Rank</th><th>Nama</th><th>Divisi</th><th>Total</th><th>SPK</th></tr>
              </thead>
              <tbody id="tbWithin"><tr><td colspan="5">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="note" style="margin-top:12px;" id="metaNote"></div>
    </div>

    <div class="note" style="text-align:center; margin:16px 0;">? Internal Tools by HCGA Jendela360 (IIA)</div>
  </div>

  <script>
    const APP_URL = "<?= appUrl ?>";
    const KEY_EMAIL = "mitraEmail";
    const KEY_REMEMBER_TOKEN = "rememberToken";

    function safeParse(m){ try { return (typeof m === "object" && m) ? m : JSON.parse(m); } catch(e){ return null; } }
    function formatNumber(n){ return new Intl.NumberFormat('id-ID').format(n || 0); }
    function money(n){ return "Rp " + formatNumber(n || 0); }
    function setMsg(t){ document.getElementById("msg").innerText = t || ""; }

    function goLogin(){ window.top.location.href = APP_URL + "?page=login"; }
    function goPage(page){
      const email = (sessionStorage.getItem(KEY_EMAIL) || "").trim().toLowerCase();
      if (!email) return goLogin();
      window.top.location.href = APP_URL + "?page=" + encodeURIComponent(page) + "&email=" + encodeURIComponent(email);
    }
    function logout(){
      sessionStorage.removeItem(KEY_EMAIL);
      localStorage.removeItem(KEY_REMEMBER_TOKEN);
      goLogin();
    }
    function requireLoginFromUrlOrSession(){
      const url = new URL(window.location.href);
      const qEmail = (url.searchParams.get("email") || "").trim().toLowerCase();
      if (qEmail){ sessionStorage.setItem(KEY_EMAIL, qEmail); return qEmail; }
      const sEmail = (sessionStorage.getItem(KEY_EMAIL) || "").trim().toLowerCase();
      return sEmail;
    }

    function renderTable(tbodyId, items){
      const tb = document.getElementById(tbodyId);
      tb.innerHTML = "";
      if (!items || !items.length){
        tb.innerHTML = `<tr><td colspan="5">Belum ada data</td></tr>`;
        return;
      }
      items.forEach((it, idx) => {
        const tr = document.createElement("tr");
        if (it.isMe) tr.classList.add("me");
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${it.name || "-"}</td>
          <td>${it.divisi || "-"}</td>
          <td>${money(it.total || 0)}</td>
          <td>${formatNumber(it.spkCount || 0)}</td>
        `;
        tb.appendChild(tr);
      });
    }

    function load(from, to){
      setMsg("");
      const email = requireLoginFromUrlOrSession();
      if (!email) return goLogin();

      google.script.run
        .withSuccessHandler((json) => {
          const res = safeParse(json);
          if (!res){ setMsg("Response tidak valid."); return; }
          if (!res.ok){ setMsg(res.message || "Gagal ambil ranking."); return; }

          document.getElementById("namaMitra").innerText = res.namaMitra || "-";
          document.getElementById("divisiText").innerText = res.userDivision ? ("? Divisi: " + res.userDivision) : "";

          renderTable("tbAcross", res.across || []);
          renderTable("tbWithin", res.within || []);

          const miss = (res.meta && res.meta.missingHeaders) ? res.meta.missingHeaders : [];
          document.getElementById("metaNote").innerText =
            miss.length ? ("Catatan: beberapa kolom belum ditemukan di database: " + miss.join(", ") + ".") : "";
        })
        .withFailureHandler((err) => setMsg("Error: " + (err && err.message ? err.message : err)))
        .getRankingPageDataByEmailWithFilter(email, from || "", to || "");
    }

    function applyFilter(){
      const from = document.getElementById("dateFrom").value || "";
      const to = document.getElementById("dateTo").value || "";
      load(from, to);
    }

    function resetFilter(){
      document.getElementById("dateFrom").value = "";
      document.getElementById("dateTo").value = "";
      load("", "");
    }

    load("", "");
  </script>
</body>
</html>
