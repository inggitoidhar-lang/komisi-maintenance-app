<!DOCTYPE html>
<html>
<head>
  <base target="_top" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --brand:#00a0c6;
      --text:#0b1220;
      --muted:#64748b;
      --border:rgba(15, 23, 42, .10);
      --radius: 18px;

      --paid:#0b8043;
      --unpaid:#b00020;

      --bg1:#0b2a57;
      --bg2:#0b3b8a;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:"Manrope", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:#ffffff;
      min-height: 100vh;
    }

    .wrap{ max-width: 1180px; margin: 0 auto; padding: 18px; }

    /* header */
    .top{
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      border: 1px solid rgba(255,255,255,.18);
      border-radius: var(--radius);
      padding: 14px 16px;
      box-shadow: 0 18px 50px rgba(2,6,23,.22);
      width: 100%;
    }

    .topRow{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .leftTop{ display:flex; align-items:center; gap:18px; flex-wrap:wrap; }
    .logoApp{ height: 30px; width:auto; display:block; }

    .title{ font-size: 16px; font-weight: 900; color:#fff; letter-spacing:.2px; }
    .subtitle{ font-size: 13px; font-weight: 800; color: rgba(255,255,255,.72); margin-top: 2px; }

    .topActions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    /* status 1 line (sesuai request) */
    .statusPill{
      display:inline-flex; align-items:center; gap:10px;
      padding: 10px 12px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.12);
      color: rgba(255,255,255,.92);
      font-weight: 900; font-size: 13px;
      backdrop-filter: blur(10px);
      white-space: nowrap;
    }
    .dot{ width:9px;height:9px;border-radius:999px;background:#22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.18); }
    .statusEmail{ color:#fff; }

    .btnIcon{
      height:44px; width:44px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.12);
      cursor:pointer;
      color:#fff;
      display:inline-flex; align-items:center; justify-content:center;
      backdrop-filter: blur(10px);
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .btnIcon:hover{ background: rgba(255,255,255,.18); border-color: rgba(255,255,255,.30); }
    .btnIcon:active{ transform: scale(.98); }
    .btnIcon svg{ width:18px; height:18px; display:block; }

    .btnSmall{
      height:44px; padding: 0 14px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.12);
      cursor:pointer;
      font-weight: 900; font-size: 14px;
      color:#fff;
      display:inline-flex; align-items:center; gap:10px;
      backdrop-filter: blur(10px);
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .btnSmall:hover{ background: rgba(255,255,255,.18); border-color: rgba(255,255,255,.30); }
    .btnSmall:active{ transform: scale(.98); }
    .btnSmall .icon svg{ width:18px; height:18px; display:block; }

    /* card */
    .card{
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
      border-radius: var(--radius);
      box-shadow: 0 10px 24px rgba(2, 6, 23, .08);
      padding: 16px;
      margin-top: 12px;
    }

    .soft{ color: var(--muted); font-weight: 700; margin-top: 6px; }
    .msg{ margin-top:10px; font-weight: 800; color: var(--unpaid); }

    /* Name block format */
    .helloBlock{ margin-bottom: 10px; }
    .helloLabel{ font-weight: 900; font-size: 12px; letter-spacing:.22px; color: var(--muted); text-transform: uppercase; }
    .helloName{ font-weight: 900; font-size: 18px; color: var(--bg2); margin-top: 4px; }

    /* totals */
    .totalsRow{ display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 14px; }
    @media (max-width: 900px){ .totalsRow{ grid-template-columns: 1fr; } }

    .totalCard{
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      padding: 14px;
      background: #fff;
      box-shadow: 0 8px 18px rgba(2,6,23,.06);
    }
    .totalCard.all{ border-left: 6px solid var(--brand); }
    .totalCard.paid{ border-left: 6px solid var(--paid); }
    .totalCard.unpaid{ border-left: 6px solid var(--unpaid); }

    .totalTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .totalLabel{ font-weight: 900; font-size: 13px; color: var(--muted); letter-spacing:.22px; text-transform: uppercase; }
    .pill{
      font-weight: 900; font-size: 12px;
      padding: 6px 10px; border-radius: 999px;
      background: rgba(0,160,198,.12);
      color: #035e73;
      border:1px solid rgba(0,160,198,.22);
      white-space: nowrap;
    }
    .totalVal{ font-weight: 900; font-size: 18px; margin-top: 10px; }

    /* filter */
    .sectionTitle{ font-size: 14px; font-weight: 900; margin: 14px 0 8px; }
    .filterTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .quickBtns{ display:flex; gap:8px; flex-wrap:wrap; }
    .quickBtns button{
      height: 34px; padding: 0 12px; border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: #fff;
      font-weight: 900; font-size: 12px;
      cursor: pointer;
      color: var(--text);
    }
    .quickBtns button.active{
      border-color: rgba(0,160,198,.45);
      background: rgba(0,160,198,.12);
      color: #035e73;
    }

    .grid{ display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
    @media (max-width: 1100px){ .grid{ grid-template-columns: repeat(2,1fr); } }
    @media (max-width: 640px){ .grid{ grid-template-columns: 1fr; } }

    label{ display:block; font-size: 12px; font-weight: 900; color: var(--muted); letter-spacing:.22px; text-transform: uppercase; margin-bottom: 6px; }
    input[type="date"], input[type="text"]{
      width:100%;
      height: 42px;
      border-radius: 12px;
      border: 1px solid rgba(15,23,42,.12);
      padding: 0 12px;
      font-weight: 800;
      outline: none;
      background:#fff;
    }
    input[type="date"]:focus, input[type="text"]:focus{
      border-color: rgba(0,160,198,.55);
      box-shadow: 0 0 0 4px rgba(0,160,198,.14);
    }

    .checkList{
      border: 1px solid rgba(15,23,42,.12);
      border-radius: 12px;
      padding: 10px;
      background: #fff;
      max-height: 116px;
      overflow:auto;
    }
    .checkItem{ display:flex; align-items:center; gap:10px; padding: 6px 6px; border-radius: 10px; }
    .checkItem:hover{ background: rgba(2,6,23,.03); }
    .checkItem input{ width: 16px; height:16px; }
    .checkItem span{ font-weight: 800; font-size: 13px; color: var(--text); }

    .actionsRow{ display:flex; justify-content:flex-end; gap:10px; margin-top: 10px; flex-wrap:wrap; }
    .btnGhost{
      height: 40px; padding: 0 12px;
      border-radius: 12px;
      border: 1px solid rgba(15,23,42,.12);
      background:#fff;
      font-weight: 900;
      cursor:pointer;
    }

    /* table */
    .tableHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top: 10px; }
    .tableTitle{ font-size: 14px; font-weight: 900; }
    .tableWrap{
      overflow:auto;
      max-height: 60vh;
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      background:#fff;
    }
    table{ width:100%; border-collapse: collapse; }
    th, td{ padding: 10px 10px; border-bottom: 1px solid rgba(15,23,42,.08); vertical-align: top; }
    th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: #fff; /* FIX: solid (biar ga transparan saat scroll) */
      font-size: 12px;
      letter-spacing: .22px;
      color: var(--muted);
      text-transform: uppercase;
      font-weight: 900;
      cursor: pointer;
      user-select:none;
      box-shadow: 0 1px 0 rgba(15,23,42,.10);
    }
    tr:hover td{ background: rgba(2,6,23,.02); }
    .sortActive{
      color: var(--brand);
      background: #e7f7fb; /* solid */
      box-shadow: inset 0 -2px 0 rgba(0,160,198,.55);
    }
    .sortArrow{ width: 10px; height: 10px; opacity:.8; display:inline-block; vertical-align: middle; margin-left: 6px; }
    .badgePaid{
      font-size: 12px; font-weight: 900;
      color: #0b8043;
      background: rgba(11,128,67,.10);
      border: 1px solid rgba(11,128,67,.22);
      padding: 4px 10px; border-radius: 999px; white-space: nowrap;
    }
    .badgeUnpaid{
      font-size: 12px; font-weight: 900;
      color: #b00020;
      background: rgba(176,0,32,.10);
      border: 1px solid rgba(176,0,32,.22);
      padding: 4px 10px; border-radius: 999px; white-space: nowrap;
    }

    .footerLight{ color: rgba(15,23,42,.45); }

    /* scrollbar biru */
    .checkList::-webkit-scrollbar{ width:10px; height:10px; }
    .checkList::-webkit-scrollbar-track{ background: rgba(0,160,198,.10); border-radius: 999px; }
    .checkList::-webkit-scrollbar-thumb{
      background: rgba(0,160,198,.60);
      border-radius: 999px;
      border: 2px solid rgba(0,160,198,.10);
    }
    .checkList::-webkit-scrollbar-thumb:hover{ background: rgba(0,160,198,.75); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="topRow">
        <div class="leftTop">
          <img class="logoApp" src="<?= logoWhiteUrl ?>" alt="Jendela360" />
          <div>
            <div class="title">Rincian Pencairan Komisi</div>
            <div class="subtitle">Cek rincian komisi berdasarkan invoice yang telah terbit</div>
          </div>
        </div>

        <div class="topActions">
          <div class="statusPill" title="Status Login">
            <span class="dot"></span>
            <span>SEDANG MASUK</span>
            <span class="statusEmail" id="loginEmailPill">-</span>
          </div>

          <button class="btnIcon" onclick="goDashboard()" title="Beranda" aria-label="Beranda">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M3 10.5L12 3l9 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M5.5 9.5V21h13V9.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M10 21v-6h4v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>

          <button class="btnSmall" onclick="logout()" title="Keluar" aria-label="Keluar">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M10 7V6a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-7a2 2 0 0 1-2-2v-1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M14 12H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M6 9l-3 3 3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            Keluar
          </button>
        </div>
      </div>
    </div>

    <div class="card" id="gateCard">
      <div style="font-weight:900;font-size:16px;">Akses Ditolak</div>
      <div class="soft">Kamu perlu masuk dulu dari Beranda.</div>
      <div id="gateMsg" class="msg"></div>
      <div style="margin-top:12px;">
        <button class="btnSmall" style="background:#fff;color:#0b1220;border-color:rgba(15,23,42,.12)" onclick="goDashboard()">Kembali Ke Beranda</button>
      </div>
    </div>

    <div class="card" id="mainCard" style="display:none;">
      <div class="helloBlock">
        <div class="helloLabel">Nama</div>
        <div class="helloName" id="namaMitra">-</div>
      </div>

      <div class="totalsRow">
        <div class="totalCard all">
          <div class="totalTop"><div class="totalLabel">Total Komisi</div><div class="pill" id="spkAll">0 SPK</div></div>
          <div class="totalVal" id="totalAll">Rp 0</div>
        </div>
        <div class="totalCard paid">
          <div class="totalTop"><div class="totalLabel">Sudah Cair</div><div class="pill" id="spkPaid">0 SPK</div></div>
          <div class="totalVal" id="totalPaid">Rp 0</div>
        </div>
        <div class="totalCard unpaid">
          <div class="totalTop"><div class="totalLabel">Belum Cair</div><div class="pill" id="spkUnpaid">0 SPK</div></div>
          <div class="totalVal" id="totalUnpaid">Rp 0</div>
        </div>
      </div>

      <div class="sectionTitle">Filter</div>

      <div class="filterTop">
        <div class="soft" style="margin:0;">Pilih filter seperlunya, lalu tabel & total akan otomatis menyesuaikan.</div>
        <div class="quickBtns">
          <button id="btnAll" class="active" onclick="setQuickStatus('ALL')">Semua</button>
          <button id="btnPaid" onclick="setQuickStatus('PAID')">Sudah Cair</button>
          <button id="btnUnpaid" onclick="setQuickStatus('UNPAID')">Belum Cair</button>
        </div>
      </div>

      <div class="grid">
        <div><label>Cetak Invoice (Awal)</label><input type="date" id="tglCetakFrom" /></div>
        <div><label>Cetak Invoice (Akhir)</label><input type="date" id="tglCetakTo" /></div>
        <div><label>Periode Pencairan</label><div id="periodeBox" class="checkList"></div></div>
        <div><label>Pekerjaan</label><div id="pekerjaanBox" class="checkList"></div></div>

        <div><label>Penjadwalan Pertama (Awal)</label><input type="date" id="tglKerjaFrom" /></div>
        <div><label>Penjadwalan Pertama (Akhir)</label><input type="date" id="tglKerjaTo" /></div>
        <div><label>Waktu Pencairan (Awal)</label><input type="date" id="waktuCairFrom" /></div>
        <div><label>Waktu Pencairan (Akhir)</label><input type="date" id="waktuCairTo" /></div>

        <div><label>Cari Kode Unit</label><input type="text" id="qUnit" placeholder="contoh: NWCC003" /></div>
        <div><label>Cari No. SPK</label><input type="text" id="qSpk" placeholder="contoh: A26JAN2731" /></div>
      </div>

      <div class="actionsRow">
        <button class="btnGhost" onclick="clearFilters()">Hapus Filter</button>
        <button class="btnGhost" onclick="downloadPDF()">Download PDF</button>
      </div>

      <div class="tableHead">
        <div class="tableTitle">Rincian</div>
        <div class="soft" id="rowCount">-</div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th data-key="tglCetak" onclick="sortBy('tglCetak')">Cetak Invoice <span class="sortArrow" id="s_tglCetak"></span></th>
              <th data-key="periode" onclick="sortBy('periode')">Periode Pencairan <span class="sortArrow" id="s_periode"></span></th>
              <th data-key="tglKerja" onclick="sortBy('tglKerja')">Penjadwalan Pertama <span class="sortArrow" id="s_tglKerja"></span></th>
              <th data-key="spk" onclick="sortBy('spk')">No. SPK <span class="sortArrow" id="s_spk"></span></th>
              <th data-key="koordinator" onclick="sortBy('koordinator')">Koordinator <span class="sortArrow" id="s_koordinator"></span></th>
              <th data-key="posisi" onclick="sortBy('posisi')">Posisi <span class="sortArrow" id="s_posisi"></span></th>
              <th data-key="pekerjaan" onclick="sortBy('pekerjaan')">Pekerjaan <span class="sortArrow" id="s_pekerjaan"></span></th>
              <th data-key="kodeUnit" onclick="sortBy('kodeUnit')">Kode Unit <span class="sortArrow" id="s_kodeUnit"></span></th>
              <th data-key="namaApt" onclick="sortBy('namaApt')">Nama Apartemen <span class="sortArrow" id="s_namaApt"></span></th>
              <th data-key="biayaJasa" onclick="sortBy('biayaJasa')">Biaya Jasa <span class="sortArrow" id="s_biayaJasa"></span></th>
              <th data-key="persenKomisi" onclick="sortBy('persenKomisi')">% Komisi <span class="sortArrow" id="s_persenKomisi"></span></th>
              <th data-key="komisi" onclick="sortBy('komisi')">Komisi <span class="sortArrow" id="s_komisi"></span></th>
              <th data-key="status" onclick="sortBy('status')">Status <span class="sortArrow" id="s_status"></span></th>
              <th data-key="waktuCair" onclick="sortBy('waktuCair')">Waktu Cair <span class="sortArrow" id="s_waktuCair"></span></th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="14" style="text-align:center;color:var(--muted);font-weight:900;padding:16px;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="footerLight" style="margin:16px 0 6px; text-align:center; font-weight:800; font-size:12px;">
      ? Internal Tools by HCGA Jendela360 (IIA)
    </div>
  </div>

  <script>
    const APP_URL = "<?= appUrl ?>";
    const PREFILL_EMAIL = "<?= prefillEmail ?>";

    let ALL_ROWS = [];
    let FILTERED_ROWS = [];

    let QUICK_STATUS = "ALL";
    let SORT_KEY = "";
    let SORT_DIR = "asc";

    function goDashboard(){
      const email = getEmail();
      if (!email){ window.top.location.href = APP_URL + "?page=login"; return; }
      window.top.location.href = APP_URL + "?page=dashboard&email=" + encodeURIComponent(email);
    }

    function logout(){
      try{
        sessionStorage.removeItem("mitraEmail");
        localStorage.removeItem("rememberToken");
      }catch(e){}
      window.top.location.href = APP_URL + "?page=login";
    }

    function getEmail(){
      const fromTpl = (PREFILL_EMAIL || "").trim().toLowerCase();
      const fromSession = (sessionStorage.getItem("mitraEmail") || "").trim().toLowerCase();
      const email = fromSession || fromTpl;
      return email;
    }

    function normalizeServerResponse(res){
      // Code.gs return JSON string, jadi harus parse dulu
      if (typeof res === "string"){
        try { return JSON.parse(res); } catch(e){ return null; }
      }
      return res;
    }

    function setQuickStatus(type){
      QUICK_STATUS = type;
      document.getElementById("btnAll").classList.toggle("active", type === "ALL");
      document.getElementById("btnPaid").classList.toggle("active", type === "PAID");
      document.getElementById("btnUnpaid").classList.toggle("active", type === "UNPAID");
      applyFilters();
    }

    function clearFilters(){
      document.getElementById('tglCetakFrom').value = "";
      document.getElementById('tglCetakTo').value = "";
      document.getElementById('tglKerjaFrom').value = "";
      document.getElementById('tglKerjaTo').value = "";
      document.getElementById('waktuCairFrom').value = "";
      document.getElementById('waktuCairTo').value = "";
      document.getElementById('qUnit').value = "";
      document.getElementById('qSpk').value = "";

      uncheckAll("periodeBox");
      uncheckAll("pekerjaanBox");

      setQuickStatus("ALL");
      applyFilters();
    }

    function uncheckAll(boxId){
      const box = document.getElementById(boxId);
      if (!box) return;
      const checks = box.querySelectorAll('input[type="checkbox"]');
      checks.forEach(c => c.checked = false);
    }

    function getCheckedValues(boxId){
      const box = document.getElementById(boxId);
      if (!box) return [];
      const checks = box.querySelectorAll('input[type="checkbox"]:checked');
      return Array.from(checks).map(c => c.value);
    }

    function safeParseMoney(v){
      const n = Number(String(v || "0").replace(/[^\d.-]/g,""));
      return isNaN(n) ? 0 : n;
    }

    function toIDR(n){
      try{
        return "Rp " + (Number(n)||0).toLocaleString("id-ID");
      }catch(e){
        return "Rp " + (Number(n)||0);
      }
    }

    function toISODate(s){
      if (!s) return "";
      if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10);
      const m = String(s).match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
      if (m){
        const dd = m[1].padStart(2,"0");
        const mm = m[2].padStart(2,"0");
        const yy = m[3];
        return `${yy}-${mm}-${dd}`;
      }
      return "";
    }

    function inRangeISO(dateISO, fromISO, toISO){
      if (!dateISO) return false;
      if (fromISO && dateISO < fromISO) return false;
      if (toISO && dateISO > toISO) return false;
      return true;
    }

    function arrowSvg(dir){
      if (dir === "asc"){
        return `<svg viewBox="0 0 24 24" fill="none"><path d="M12 6l-5 6h10l-5-6z" fill="currentColor"/></svg>`;
      }
      return `<svg viewBox="0 0 24 24" fill="none"><path d="M12 18l5-6H7l5 6z" fill="currentColor"/></svg>`;
    }

    function clearSortIndicators(){
      document.querySelectorAll("th").forEach(th => th.classList.remove("sortActive"));
      document.querySelectorAll(".sortArrow").forEach(el => el.innerHTML = "");
    }

    function getSortValue(row, key){
      if (!row) return "";
      const map = {
        tglCetak: toISODate(row.tglCetak || ""),
        periode: (row.periode || ""),
        tglKerja: toISODate(row.tglKerja || ""),
        spk: (row.spk || ""),
        koordinator: (row.koordinator || ""),
        posisi: (row.posisi || ""),
        pekerjaan: (row.pekerjaan || ""),
        kodeUnit: (row.kodeUnit || ""),
        namaApt: (row.namaApt || ""),
        biayaJasa: safeParseMoney(row.biayaJasa),
        persenKomisi: safeParseMoney(row.persenKomisi),
        komisi: safeParseMoney(row.komisi),
        status: (row.status || ""),
        waktuCair: toISODate(row.waktuCair || "")
      };
      return map[key] ?? "";
    }

    function applySorting(){
      if (!SORT_KEY) return;
      const dirMul = (SORT_DIR === "asc") ? 1 : -1;
      FILTERED_ROWS.sort((a,b) => {
        const va = getSortValue(a, SORT_KEY);
        const vb = getSortValue(b, SORT_KEY);
        if (typeof va === "number" && typeof vb === "number") return (va - vb) * dirMul;
        if (va < vb) return -1 * dirMul;
        if (va > vb) return  1 * dirMul;
        return 0;
      });

      clearSortIndicators();
      const th = document.querySelector(`th[data-key="${SORT_KEY}"]`);
      if (th) th.classList.add("sortActive");
      const el = document.getElementById("s_" + SORT_KEY);
      if (el) el.innerHTML = arrowSvg(SORT_DIR);
    }

    function sortBy(key){
      if (!key) return;
      if (SORT_KEY === key) SORT_DIR = (SORT_DIR === "asc") ? "desc" : "asc";
      else { SORT_KEY = key; SORT_DIR = "asc"; }
      applySorting();
      renderTable(FILTERED_ROWS);
    }

    function applyFilters(){
      if (!ALL_ROWS || ALL_ROWS.length === 0) {
        renderTotals([]);
        renderTable([]);
        return;
      }

      const tglCetakFrom = document.getElementById('tglCetakFrom').value;
      const tglCetakTo   = document.getElementById('tglCetakTo').value;
      const tglKerjaFrom = document.getElementById('tglKerjaFrom').value;
      const tglKerjaTo   = document.getElementById('tglKerjaTo').value;
      const waktuCairFrom = document.getElementById('waktuCairFrom').value;
      const waktuCairTo   = document.getElementById('waktuCairTo').value;

      const periodePicked = getCheckedValues("periodeBox");
      const pekerjaanPicked = getCheckedValues("pekerjaanBox");

      const qUnit = (document.getElementById('qUnit').value || "").trim().toLowerCase();
      const qSpk  = (document.getElementById('qSpk').value || "").trim().toLowerCase();

      FILTERED_ROWS = ALL_ROWS.filter(r => {
        if (QUICK_STATUS === "PAID" && String(r.status||"").toUpperCase() !== "SUDAH CAIR") return false;
        if (QUICK_STATUS === "UNPAID" && String(r.status||"").toUpperCase() !== "BELUM CAIR") return false;

        const tCetak = toISODate(r.tglCetak || "");
        if ((tglCetakFrom || tglCetakTo) && !inRangeISO(tCetak, tglCetakFrom, tglCetakTo)) return false;

        const tKerja = toISODate(r.tglKerja || "");
        if ((tglKerjaFrom || tglKerjaTo) && !inRangeISO(tKerja, tglKerjaFrom, tglKerjaTo)) return false;

        const tCair = toISODate(r.waktuCair || "");
        if ((waktuCairFrom || waktuCairTo) && !inRangeISO(tCair, waktuCairFrom, waktuCairTo)) return false;

        if (periodePicked.length && !periodePicked.includes(String(r.periode||""))) return false;
        if (pekerjaanPicked.length && !pekerjaanPicked.includes(String(r.pekerjaan||""))) return false;

        if (qUnit && !String(r.kodeUnit||"").toLowerCase().includes(qUnit)) return false;
        if (qSpk && !String(r.spk||"").toLowerCase().includes(qSpk)) return false;

        return true;
      });

      applySorting();
      renderTotals(FILTERED_ROWS);
      renderTable(FILTERED_ROWS);
    }

    function renderTotals(rows){
      let all = 0, paid = 0, unpaid = 0;
      let cAll=0, cPaid=0, cUnpaid=0;

      rows.forEach(r => {
        const kom = safeParseMoney(r.komisi);
        cAll += kom; all++;
        const st = String(r.status||"").toUpperCase();
        if (st === "SUDAH CAIR"){ cPaid += kom; paid++; }
        else if (st === "BELUM CAIR"){ cUnpaid += kom; unpaid++; }
      });

      document.getElementById("spkAll").textContent = `${all} SPK`;
      document.getElementById("spkPaid").textContent = `${paid} SPK`;
      document.getElementById("spkUnpaid").textContent = `${unpaid} SPK`;

      document.getElementById("totalAll").textContent = toIDR(cAll);
      document.getElementById("totalPaid").textContent = toIDR(cPaid);
      document.getElementById("totalUnpaid").textContent = toIDR(cUnpaid);

      document.getElementById("rowCount").textContent = `${rows.length} Baris`;
    }

    function badgeForStatus(st){
      const up = String(st||"").toUpperCase();
      if (up === "SUDAH CAIR") return `<span class="badgePaid">Sudah Cair</span>`;
      if (up === "BELUM CAIR") return `<span class="badgeUnpaid">Belum Cair</span>`;
      return `<span class="badgeUnpaid">${st || "-"}</span>`;
    }

    function renderTable(rows){
      const tb = document.getElementById("tbody");
      if (!rows || rows.length === 0){
        tb.innerHTML = `<tr><td colspan="14" style="text-align:center;color:var(--muted);font-weight:900;padding:16px;">Tidak ada data.</td></tr>`;
        return;
      }

      tb.innerHTML = rows.map(r => `
        <tr>
          <td>${r.tglCetak || "-"}</td>
          <td>${r.periode || "-"}</td>
          <td>${r.tglKerja || "-"}</td>
          <td>${r.spk || "-"}</td>
          <td>${r.koordinator || "-"}</td>
          <td>${r.posisi || "-"}</td>
          <td>${r.pekerjaan || "-"}</td>
          <td>${r.kodeUnit || "-"}</td>
          <td>${r.namaApt || "-"}</td>
          <td>${toIDR(safeParseMoney(r.biayaJasa))}</td>
          <td>${(r.persenKomisi ?? "-")}</td>
          <td>${toIDR(safeParseMoney(r.komisi))}</td>
          <td>${badgeForStatus(r.status)}</td>
          <td>${r.waktuCair || "-"}</td>
        </tr>
      `).join("");
    }

    function fillChecklist(boxId, items){
      const box = document.getElementById(boxId);
      if (!box) return;
      const safeItems = (items || []).filter(Boolean);
      if (!safeItems.length){
        box.innerHTML = `<div class="soft" style="margin:0;">-</div>`;
        return;
      }
      box.innerHTML = safeItems.map(v => `
        <label class="checkItem">
          <input type="checkbox" value="${String(v).replace(/"/g,'&quot;')}" />
          <span>${v}</span>
        </label>
      `).join("");

      box.querySelectorAll('input[type="checkbox"]').forEach(el => {
        el.addEventListener("change", applyFilters);
      });
    }

    function downloadPDF(){
      try{
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });

        doc.setFontSize(12);
        doc.text("Rincian Pencairan Komisi", 40, 36);

        const head = [[
          "Cetak Invoice","Periode","Penjadwalan","No SPK","Koordinator","Posisi",
          "Pekerjaan","Kode Unit","Nama Apartemen","Biaya Jasa","%","Komisi","Status","Waktu Cair"
        ]];

        const body = (FILTERED_ROWS || []).map(r => ([
          r.tglCetak || "-", r.periode || "-", r.tglKerja || "-", r.spk || "-", r.koordinator || "-",
          r.posisi || "-", r.pekerjaan || "-", r.kodeUnit || "-", r.namaApt || "-",
          String(r.biayaJasa || "-"), String(r.persenKomisi || "-"), String(r.komisi || "-"),
          String(r.status || "-"), String(r.waktuCair || "-")
        ]));

        doc.autoTable({
          head, body,
          startY: 54,
          styles: { fontSize: 8, cellPadding: 4 },
          headStyles: { fillColor: [11, 59, 138] }
        });

        doc.save("rincian_pencairan_komisi.pdf");
      }catch(e){
        alert("Gagal download PDF: " + e);
      }
    }

    function init(){
      const email = getEmail();
      if (!email){
        document.getElementById("gateMsg").textContent = "Email tidak ditemukan. Silakan login dulu.";
        document.getElementById("gateCard").style.display = "";
        document.getElementById("mainCard").style.display = "none";
        return;
      }

      document.getElementById("loginEmailPill").textContent = email;

      google.script.run
        .withSuccessHandler(raw => {
          const res = normalizeServerResponse(raw);

          if (!res || !res.ok){
            document.getElementById("gateMsg").textContent =
              (res && res.message) ? res.message : "Gagal memuat data.";
            document.getElementById("gateCard").style.display = "";
            document.getElementById("mainCard").style.display = "none";
            return;
          }

          // simpan email supaya page lain gampang ambil
          try{ sessionStorage.setItem("mitraEmail", email); }catch(e){}

          document.getElementById("gateCard").style.display = "none";
          document.getElementById("mainCard").style.display = "";

          // FIX: field dari server adalah namaMitra
          document.getElementById("namaMitra").textContent = res.namaMitra || "-";

          ALL_ROWS = res.rows || [];
          FILTERED_ROWS = ALL_ROWS.slice();

          fillChecklist("periodeBox", (res.filterOptions && res.filterOptions.periode) ? res.filterOptions.periode : []);
          fillChecklist("pekerjaanBox", (res.filterOptions && res.filterOptions.pekerjaan) ? res.filterOptions.pekerjaan : []);

          ["tglCetakFrom","tglCetakTo","tglKerjaFrom","tglKerjaTo","waktuCairFrom","waktuCairTo","qUnit","qSpk"].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener("input", applyFilters);
            el.addEventListener("change", applyFilters);
          });

          applyFilters();
        })
        .withFailureHandler(err => {
          document.getElementById("gateMsg").textContent = "Error: " + err;
          document.getElementById("gateCard").style.display = "";
          document.getElementById("mainCard").style.display = "none";
        })
        .getKomisiDatasetByEmail(email);
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
