<!DOCTYPE html>
<html>
<head>
  <base target="_top" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#00a0c6;
      --text:#0b1220;
      --muted:#64748b;
      --border:rgba(15, 23, 42, .10);
      --radius: 18px;

      --good:#0b8043;
      --bad:#b00020;
      --soft:#f7fafc;

      --bg1:#0b2a57;
      --bg2:#0b3b8a;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:"Manrope", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:#ffffff;
      min-height: 100vh;
    }

    .wrap{ max-width: 1180px; margin: 0 auto; padding: 18px; }

    .card{
      background: #fff;
      border:1px solid rgba(15,23,42,.10);
      border-radius: var(--radius);
      box-shadow: 0 10px 24px rgba(2, 6, 23, .08);
      padding: 16px;
      margin-top: 12px;
    }

    .btn{
      height:44px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-weight: 900;
      cursor:pointer;
      font-size: 14px;
      font-family: inherit;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
      transition: transform .05s ease, box-shadow .15s ease, background .15s ease;
      user-select:none;
      gap:10px;
    }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color:#fff;
      box-shadow: 0 10px 18px rgba(11, 43, 87, .18);
    }

    .btn.ghost{
      background:#fff;
      border-color: rgba(15,23,42,.14);
      color: var(--text);
    }
    .btn.ghost:hover{ background: var(--soft); }
    .btn.block{ width:100%; }

    .copyright{
      text-align:center;
      margin:16px 0;
      font-size: 11px;
      font-weight: 800;
      color: rgba(15,23,42,.55);
      letter-spacing:.2px;
    }

    /* ===== Header ===== */
    .top{
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      border: 1px solid rgba(255,255,255,.18);
      border-radius: var(--radius);
      padding: 14px 16px;
      box-shadow: 0 18px 50px rgba(2,6,23,.22);
      width: 100%;
    }
    .topRow{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }

    .leftTop{ display:flex; align-items:center; gap:26px; flex-wrap:wrap; }

    .logoApp{ height: 44px; width:auto; display:block; }

    .title{ font-size: 16px; font-weight: 900; letter-spacing: .2px; color:#fff; }
    .subtitle{ margin-top:2px; color: rgba(255,255,255,.75); font-size: 12px; font-weight: 800; }

    .topActions{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .statusPill{
      display:inline-flex; align-items:center; gap:10px;
      padding: 10px 12px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.12);
      color: rgba(255,255,255,.75);
      font-weight: 900; font-size: 13px;
      backdrop-filter: blur(10px);
    }
    .dot{ width:10px;height:10px;border-radius:999px; background:#22c55e; box-shadow: 0 0 0 5px rgba(34,197,94,.14); }
    .statusText{ display:flex; align-items:baseline; gap:8px; flex-wrap:wrap; }
    .statusText .label{ color: rgba(255,255,255,.75); font-weight: 900; }
    .statusText .email{ color: #fff; font-weight: 900; }
    #loginRolePill{ opacity:.95; }

    .pillClickable{
      cursor:pointer;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
      transition: background .15s ease, transform .05s ease;
      user-select:none;
    }
    .pillClickable:hover{ background: rgba(255,255,255,.18); }
    .pillClickable:active{ transform: translateY(1px); }
    .pillDisabled{
      cursor: default !important;
      opacity: .9;
      border-color: rgba(255,255,255,.16) !important;
      background: rgba(255,255,255,.08) !important;
    }

    .btnSmall{
      height:44px; padding: 0 14px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.12);
      cursor:pointer;
      font-weight: 900; font-size: 14px;
      color:#fff;
      display:inline-flex; align-items:center; gap:10px;
      backdrop-filter: blur(10px);
    }
    .btnSmall:hover{ background: rgba(255,255,255,.18); }

    .btnIcon{
      width: 42px;
      padding: 0;
      justify-content:center;
    }
    .icon{
      width:18px;
      height:18px;
      display:inline-block;
    }
    .icon svg{ width:100%; height:100%; display:block; }

    .sectionTitle{ font-weight: 900; font-size: 16px; margin-bottom: 6px; }
    .sectionNote{ color: var(--muted); font-size: 12px; line-height:1.35; }

    /* ===== Row atas ===== */
    .profileRow{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
      margin-top: 10px;
      align-items:stretch;
    }
    @media (max-width: 900px){ .profileRow{ grid-template-columns: 1fr; } }

    .hello{ font-size: 14px; font-weight: 900; color:#0b1220; }

    .helloName{
      font-size: 18px;
      font-weight: 900;
      margin-top: 3px;
      color: rgba(0,160,198,1);
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .miniPillHeaderStyle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;

      border: 1px solid rgba(15,23,42,.14);
      background: rgba(15,23,42,.06);
      color: rgba(11,18,32,.78);

      font-weight: 900;
      font-size: 12px;
      white-space: nowrap;
      box-shadow: 0 10px 22px rgba(2, 6, 23, .06);
    }

    .miniPillHeaderStyle .mutedLabel{ display:none; }
    .miniPillHeaderStyle .valWhite{ color: rgba(11,18,32,.78); font-weight: 900; }

    .pillHide{ display:none !important; }

    .leftCol{
      display:flex;
      flex-direction:column;
      height:100%;
    }

    .progressWrap{
      margin-top: 12px;
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 18px;
      padding: 12px;
      background: #fff;

      flex: 1;
      display:flex;
      flex-direction:column;
      justify-content:center;
      min-height: 184px;
    }

    .progressTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .progressTitle{ font-weight: 900; }
    .progressSub{ font-size: 12px; color: var(--muted); font-weight: 800; margin-top:4px; line-height:1.25; }

    .barRowTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 6px 0 10px 0;
    }

    .barHint{
      font-size: 12px;
      font-weight: 900;
      color: rgba(15,23,42,.45);
      letter-spacing: .2px;
    }

    .barTextTop{
      font-size: 12px;
      font-weight: 900;
      color: rgba(0,160,198,1);
      letter-spacing: .2px;
      text-align:right;
      margin: 0;
    }

    .barOuter{
      width:100%;
      height: 18px;
      border-radius: 999px;
      background: rgba(15,23,42,.08);
      overflow:hidden;
      border: 1px solid rgba(15,23,42,.08);
    }
    .barInner{
      height:100%;
      width:0%;
      background: linear-gradient(135deg, rgba(0,160,198,1), rgba(0,160,198,.88));
      border-radius: 999px;
      transition: width .25s ease;
    }

    .filterBox{
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 18px;
      padding: 12px;
      background: #fff;
      min-height: 184px;
      display:flex;
      flex-direction:column;
    }
    .labelSmall{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .dateInput{
      width:100%;
      height:48px;
      padding: 12px 12px;
      border: 1px solid rgba(15,23,42,.12);
      border-radius: 14px;
      font-size: 14px;
      outline:none;
      background:#fff;
      font-family: inherit;
      font-weight: 800;
    }

    .filterGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items:end;
      margin-top:10px;
    }
    .filterActions{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .filterActions .btn{ flex:1; }

    .rankTopRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .rankTitleInline{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .rankGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
      align-items:start;
    }
    @media (max-width: 900px){ .rankGrid{ grid-template-columns: 1fr; } }

    .rankCard{
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 18px;
      background:#fff;
      overflow:hidden;
    }

    .rankCardHeader{
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.18);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;

      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color:#fff;
    }
    .rankCardTitle{ font-weight: 900; font-size: 13px; color:#fff; }

    .rankTableWrap{
      max-height: 152px;
      overflow:auto;
    }
    .rankTableWrap::-webkit-scrollbar{
      width:10px;
      height:10px;
    }

    .rankTableWrap::-webkit-scrollbar-track{
      background: rgba(11,42,87,.18);
      border-radius: 999px;
    }

    .rankTableWrap::-webkit-scrollbar-thumb{
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.15);
    }

    .rankTableWrap::-webkit-scrollbar-thumb:hover{
      background: linear-gradient(135deg, #0b3b8a, #0b2a57);
    }

    table{ width:100%; border-collapse: collapse; font-size: 12px; }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(15,23,42,.08);
      text-align:left;
      white-space:nowrap;
    }
    th{
      position: sticky;
      top: 0;
      background:#fff;
      z-index: 2;
      font-weight: 900;
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .2px;
    }
    tr.meRow td{
      background: rgba(0,160,198,.10);
      font-weight: 900;
    }

    .metricGrid{
      display:grid;
      grid-template-columns: repeat(5, minmax(170px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 1100px){ .metricGrid{ grid-template-columns: repeat(3, minmax(170px, 1fr)); } }
    @media (max-width: 700px){ .metricGrid{ grid-template-columns: repeat(2, minmax(160px, 1fr)); } }
    @media (max-width: 420px){ .metricGrid{ grid-template-columns: 1fr; } }

    .metric{
      position: relative;
      border:1px solid rgba(15,23,42,.10);
      border-radius: 18px;
      padding: 14px;
      background:#fff;
      overflow:hidden;
      box-shadow: 0 10px 22px rgba(2, 6, 23, .06);
    }

    .metric.brand{ background: rgba(0,160,198,.08); border-color: rgba(0,160,198,.16); }
    .metric.good{ background: rgba(11,128,67,.06); border-color: rgba(11,128,67,.16); }
    .metric.bad{ background: rgba(176,0,32,.06); border-color: rgba(176,0,32,.16); }

    .metric::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:0;
      height: 7px;
      border-bottom-left-radius: 18px;
      border-bottom-right-radius: 18px;
      background: rgba(15,23,42,.35);
      opacity: .0;
    }
    .metric.brand::after{ background: rgba(0,160,198,.85); opacity:1; }
    .metric.good::after{ background: rgba(11,128,67,.85); opacity:1; }
    .metric.bad::after{ background: rgba(176,0,32,.85); opacity:1; }

    .metricTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .metricLabel{
      font-size:12px;
      color: rgba(11,18,32,.62);
      font-weight: 900;
    }

    .pill{
      font-size: 11px;
      font-weight: 900;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background:#ffffff;
      color: rgba(11,18,32,.60);
      white-space:nowrap;
    }

    .metricVal{ font-size: 22px; font-weight: 900; letter-spacing: .2px; color: rgba(11,18,32,.90); }
    .metric.brand .metricVal{ color: rgba(0,160,198,1); }
    .metric.good .metricVal{ color: rgba(11,128,67,1); }
    .metric.bad .metricVal{ color: rgba(176,0,32,1); }

    .metricIcon{
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 auto;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.55);
    }
    .metricIcon svg{ width: 16px; height: 16px; display:block; }

    .metric.brand .metricIcon{
      border-color: rgba(0,160,198,.28);
      background: rgba(255,255,255,.65);
      color: rgba(0,160,198,1);
    }
    .metric.good .metricIcon{
      border-color: rgba(11,128,67,.28);
      background: rgba(255,255,255,.65);
      color: rgba(11,128,67,1);
    }
    .metric.bad .metricIcon{
      border-color: rgba(176,0,32,.28);
      background: rgba(255,255,255,.65);
      color: rgba(176,0,32,1);
    }

    .msg{
      margin-top:10px;
      color:#b00020;
      font-size: 13px;
      font-weight: 900;
      min-height: 18px;
    }

    .hideNote{ display:none !important; }

    /* =========================
       MODAL "Login Sebagai"
       ========================= */
    .modalBack{
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 9999;
    }
    .modalBack.show{ display:flex; }

    .modalCard{
      width: min(760px, 100%);
      background:#fff;
      border-radius: 20px;
      border: 1px solid rgba(15,23,42,.12);
      box-shadow: 0 30px 80px rgba(2,6,23,.35);
      overflow:hidden;
    }
    .modalHeader{
      padding: 14px 14px;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalTitle{
      font-weight: 900;
      letter-spacing:.2px;
      font-size: 14px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .modalSub{
      font-size: 12px;
      font-weight: 800;
      color: rgba(255,255,255,.75);
      margin-top: 3px;
    }
    .modalClose{
      height: 40px;
      width: 40px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.12);
      cursor:pointer;
      color:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      backdrop-filter: blur(10px);
    }
    .modalClose:hover{ background: rgba(255,255,255,.18); }

    .modalBody{
      padding: 14px;
    }

    .segRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .segBtn{
      height: 40px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.14);
      background:#fff;
      cursor:pointer;
      font-weight: 900;
      font-family: inherit;
      color: rgba(11,18,32,.85);
      transition: background .15s ease, transform .05s ease, box-shadow .15s ease;
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .segBtn:hover{ background: rgba(15,23,42,.05); }
    .segBtn:active{ transform: translateY(1px); }
    .segBtn.active{
      border-color: rgba(0,160,198,.30);
      background: rgba(0,160,198,.10);
      color: rgba(0,160,198,1);
      box-shadow: 0 10px 22px rgba(2,6,23,.06);
    }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items:end;
    }
    @media (max-width: 720px){ .formGrid{ grid-template-columns: 1fr; } }

    .select{
      width:100%;
      height:48px;
      padding: 12px 12px;
      border: 1px solid rgba(15,23,42,.12);
      border-radius: 14px;
      font-size: 14px;
      outline:none;
      background:#fff;
      font-family: inherit;
      font-weight: 800;
      color: rgba(11,18,32,.92);
    }

    .hintBox{
      margin-top: 10px;
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      background: rgba(15,23,42,.03);
      padding: 10px 12px;
      color: rgba(11,18,32,.72);
      font-size: 12px;
      font-weight: 800;
      line-height: 1.35;
    }

    .previewBox{
      margin-top: 12px;
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      padding: 12px;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .previewLeft{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width: 220px;
    }
    .previewLabel{
      font-size: 11px;
      font-weight: 900;
      color: rgba(11,18,32,.55);
      text-transform: uppercase;
      letter-spacing:.2px;
    }
    .previewName{
      font-size: 14px;
      font-weight: 900;
      color: rgba(11,18,32,.90);
    }
    .previewMeta{
      font-size: 12px;
      font-weight: 800;
      color: rgba(11,18,32,.62);
    }

    .modalActions{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btnDanger{
      background: rgba(176,0,32,.08);
      border: 1px solid rgba(176,0,32,.20);
      color: rgba(176,0,32,1);
    }
    .btnDanger:hover{ background: rgba(176,0,32,.10); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="topRow">
        <div class="leftTop">
          <img class="logoApp" src="https://res.cloudinary.com/dkps3vy8m/image/upload/v1770658185/6_kqt426.png" alt="Jendela360" />
          <div>
            <div class="title">Beranda</div>
            <div class="subtitle">Halaman ringkasan dan akses fitur</div>
          </div>
        </div>

        <div class="topActions">
          <div class="statusPill">
            <span class="dot"></span>
            <span class="statusText">
              <span class="label">Sedang Masuk</span>
              <span class="email" id="loginEmailPill">-</span>

              <span class="label" style="opacity:.85;">• Login sebagai</span>
              <span class="email pillClickable pillDisabled" id="loginRolePill" title="Pilih mode akses">Pengguna</span>
            </span>
          </div>

          <button class="btnSmall" onclick="logout()" title="Keluar">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M10 7V6a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-7a2 2 0 0 1-2-2v-1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M14 12H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M6 9l-3 3 3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            Keluar
          </button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="profileRow">
        <div class="leftCol">
          <div class="hello">Halo,</div>

          <div class="helloName">
            <span id="namaMitra">-</span>

            <span id="posisiPill" class="miniPillHeaderStyle">-</span>

            <span id="divisiPill" class="miniPillHeaderStyle">
              <span class="valWhite" id="divisiVal">-</span>
            </span>

            <span id="statusKaryawanPill" class="miniPillHeaderStyle">
              <span class="valWhite" id="statusKaryawanVal">-</span>
            </span>
          </div>

          <div class="progressWrap">
            <div class="progressTop">
              <div>
                <div class="progressTitle">Pencapaian Target</div>
                <div class="progressSub">Berdasarkan jumlah SPK pada periode filter</div>
              </div>
            </div>

            <div class="barRowTop">
              <div class="barHint">Progress</div>
              <div class="barTextTop" id="barTextTop">0/0 • 0%</div>
            </div>

            <div class="barOuter">
              <div class="barInner" id="barInner"></div>
            </div>
          </div>
        </div>

        <div class="filterBox">
          <div class="sectionTitle" style="margin:0;">Filter</div>

          <div class="filterGrid">
            <div>
              <div class="labelSmall">Tanggal Awal</div>
              <input class="dateInput" type="date" id="dateFrom" />
            </div>
            <div>
              <div class="labelSmall">Tanggal Akhir</div>
              <input class="dateInput" type="date" id="dateTo" />
            </div>
          </div>

          <div class="filterActions">
            <button class="btn ghost" onclick="resetHomeFilter()">
              <span class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M20 12a8 8 0 1 1-2.34-5.66" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M20 4v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              Reset
            </button>
            <button class="btn primary" onclick="applyHomeFilter()">
              <span class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M4 6h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M7 12h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M10 18h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
              Terapkan
            </button>
          </div>

          <div class="sectionNote" style="margin-top:8px;">
            Filter memengaruhi seluruh data di beranda ini (target, peringkat, dan semua ringkasan).
          </div>

          <div id="msg" class="msg"></div>
        </div>
      </div>

      <div class="rankTopRow">
        <div>
          <div class="rankTitleInline">
            <div class="sectionTitle" style="margin:0;">Peringkat</div>

            <button class="btn ghost btnIcon" onclick="goPage('ranking')" title="Buka Ranking (Fullscreen)" aria-label="Buka Ranking (Fullscreen)">
              <span class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M9 3H5a2 2 0 0 0-2 2v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M15 3h4a2 2 0 0 1 2 2v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M9 21H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M15 21h4a2 2 0 0 0 2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
            </button>
          </div>
          <div class="sectionNote">
            Peringkat berdasarkan total komisi (periode filter).
          </div>
        </div>
      </div>

      <div class="rankGrid">
        <div class="rankCard">
          <div class="rankCardHeader">
            <div class="rankCardTitle">Peringkat Antar Divisi (Top 10)</div>
          </div>
          <div class="rankTableWrap">
            <table>
              <thead>
                <tr>
                  <th>Rank</th><th>Nama</th><th>Posisi</th><th>Total Komisi</th><th>Jumlah SPK</th>
                </tr>
              </thead>
              <tbody id="tbodyAcross">
                <tr><td colspan="5">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="rankCard">
          <div class="rankCardHeader">
            <div class="rankCardTitle">Peringkat Dalam Divisi (Top 3)</div>
          </div>
          <div class="rankTableWrap">
            <table>
              <thead>
                <tr>
                  <th>Rank</th><th>Nama</th><th>Posisi</th><th>Total Komisi</th><th>Jumlah SPK</th>
                </tr>
              </thead>
              <tbody id="tbodyWithin">
                <tr><td colspan="5">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">Ringkasan Pengerjaan</div>

      <div class="metricGrid">
        <div class="metric brand">
          <div class="metricTop">
            <div class="metricLabel">Total Pengerjaan</div>
            <div class="metricIcon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M4 4h7v7H4V4Zm9 0h7v7h-7V4ZM4 13h7v7H4v-7Zm9 0h7v7h-7v-7Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
          <div class="metricVal" id="workAll">0</div>
        </div>

        <div class="metric good">
          <div class="metricTop">
            <div class="metricLabel">Pengerjaan Sudah Selesai</div>
            <div class="metricIcon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
          <div class="metricVal" id="workDone">0</div>
        </div>

        <div class="metric bad">
          <div class="metricTop">
            <div class="metricLabel">Pengerjaan Belum Selesai</div>
            <div class="metricIcon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M12 9v4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                <path d="M12 17h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                <path d="M10.3 4.2h3.4L22 20H2L10.3 4.2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
          <div class="metricVal" id="workNotDone">0</div>
        </div>

        <div class="metric good">
          <div class="metricTop">
            <div class="metricLabel">Selesai • Sudah Jadi Invoice</div>
            <div class="metricIcon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
          <div class="metricVal" id="workDoneInvoiced">0</div>
        </div>

        <div class="metric bad">
          <div class="metricTop">
            <div class="metricLabel">Selesai • Belum Jadi Invoice</div>
            <div class="metricIcon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M12 9v4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                <path d="M12 17h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                <path d="M10.3 4.2h3.4L22 20H2L10.3 4.2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
          <div class="metricVal" id="workDoneNotInvoiced">0</div>
        </div>
      </div>

      <div style="margin-top:14px;">
        <button class="btn primary block" onclick="goHistoriPengerjaan()">
          <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M8 6h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M8 12h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M8 18h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M3 6h1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M3 12h1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M3 18h1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </span>
          Cek Rincian Pengerjaan
        </button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">Ringkasan Pencairan Komisi</div>

      <div class="metricGrid" style="grid-template-columns: repeat(3, minmax(220px, 1fr));">
        <div class="metric brand">
          <div class="metricTop">
            <div class="metricLabel">Total Komisi</div>
            <div style="display:flex; align-items:center; gap:10px;">
              <div class="pill" id="spkAll">0 SPK</div>
              <div class="metricIcon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M4 4h7v7H4V4Zm9 0h7v7h-7V4ZM4 13h7v7H4v-7Zm9 0h7v7h-7v-7Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                </svg>
              </div>
            </div>
          </div>
          <div class="metricVal" id="totalAll">Rp 0</div>
        </div>

        <div class="metric good">
          <div class="metricTop">
            <div class="metricLabel">Sudah Cair</div>
            <div style="display:flex; align-items:center; gap:10px;">
              <div class="pill" id="spkPaid">0 SPK</div>
              <div class="metricIcon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            </div>
          </div>
          <div class="metricVal" id="totalPaid">Rp 0</div>
        </div>

        <div class="metric bad">
          <div class="metricTop">
            <div class="metricLabel">Belum Cair</div>
            <div style="display:flex; align-items:center; gap:10px;">
              <div class="pill" id="spkUnpaid">0 SPK</div>
              <div class="metricIcon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M12 9v4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                  <path d="M12 17h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                  <path d="M10.3 4.2h3.4L22 20H2L10.3 4.2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                </svg>
              </div>
            </div>
          </div>
          <div class="metricVal" id="totalUnpaid">Rp 0</div>
        </div>
      </div>

      <div style="margin-top:14px;">
        <button class="btn primary block" onclick="goPage('komisi')">
          <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M8 6h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M8 12h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M8 18h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M3 6h1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M3 12h1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M3 18h1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </span>
          Cek Rincian Pencairan Komisi
        </button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">Ringkasan Pendapatan Bersih</div>

      <div class="metricGrid" style="grid-template-columns: repeat(3, minmax(220px, 1fr));">
        <div class="metric brand">
          <div class="metricTop">
            <div class="metricLabel">Total Pendapatan Bersih</div>
            <div class="metricIcon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M4 4h7v7H4V4Zm9 0h7v7h-7V4ZM4 13h7v7H4v-7Zm9 0h7v7h-7v-7Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
          <div class="metricVal" id="netTotal">Rp 0</div>
        </div>

        <div class="metric good">
          <div class="metricTop">
            <div class="metricLabel">Total Pemasukan Bersih</div>
            <div class="metricIcon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
          <div class="metricVal" id="netIncome">Rp 0</div>
        </div>

        <div class="metric bad">
          <div class="metricTop">
            <div class="metricLabel">Total Potongan</div>
            <div class="metricIcon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M12 9v4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                <path d="M12 17h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                <path d="M10.3 4.2h3.4L22 20H2L10.3 4.2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
          <div class="metricVal" id="netDeduction">Rp 0</div>
        </div>
      </div>

      <div style="margin-top:14px;">
        <button class="btn primary block" onclick="goPage('bersih')">
          <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M8 6h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M8 12h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M8 18h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M3 6h1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M3 12h1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M3 18h1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </span>
          Cek Ringkasan Pendapatan Bersih
        </button>
      </div>
    </div>

    <div class="copyright">© Internal Tools by HCGA Jendela360 (IIA)</div>
  </div>

  <!-- MODAL -->
  <div class="modalBack" id="roleModalBack" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="roleModalTitle">
      <div class="modalHeader">
        <div>
          <div class="modalTitle" id="roleModalTitle">Pilih Mode Akses</div>
          <div class="modalSub" id="roleModalSubtitle">Khusus Leader / Management</div>
        </div>
        <button class="modalClose" onclick="closeRoleModal()" aria-label="Tutup">
          <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M18 6 6 18" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
              <path d="M6 6l12 12" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
            </svg>
          </span>
        </button>
      </div>

      <div class="modalBody">
        <div class="segRow" id="modeSegRow">
          <button class="segBtn active" data-mode="staff" onclick="selectMode('staff')" id="segStaff">Login sebagai Staff</button>
          <button class="segBtn" data-mode="leader" onclick="selectMode('leader')" id="segLeader">Login sebagai Leader</button>
        </div>

        <div class="formGrid">
          <div>
            <div class="labelSmall">Divisi (scope)</div>
            <select class="select" id="impersonateDivisi">
              <option value="">(Auto)</option>
              <option value="AC">AC</option>
              <option value="Fixing">Fixing</option>
              <option value="Cleaning">Cleaning</option>
              <option value="General">General</option>
            </select>
          </div>

          <div>
            <div class="labelSmall">Pilih Orang</div>
            <select class="select" id="impersonatePerson">
              <option value="">— Pilih nama —</option>
            </select>
          </div>
        </div>

        <div class="hintBox" id="roleHint"></div>

        <div class="previewBox" id="impersonatePreview">
          <div class="previewLeft">
            <div class="previewLabel">Preview</div>
            <div class="previewName" id="previewName">—</div>
            <div class="previewMeta" id="previewMeta">Mode: Login sebagai Staff</div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <span class="pill" id="previewRolePill">Role: Staff</span>
            <span class="pill" id="previewDivisiPill">Divisi: -</span>
          </div>
        </div>

        <div class="modalActions">
          <button class="btn ghost btnDanger" onclick="resetImpersonationUI()" title="Kembali ke akun asli">Reset</button>
          <button class="btn ghost" onclick="closeRoleModal()">Batal</button>
          <button class="btn primary" onclick="applyImpersonationUI()">Terapkan</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const APP_URL = "<?= appUrl ?>";
    const PREFILL_EMAIL = "<?= prefillEmail ?>";

    const KEY_EMAIL = "mitraEmail";
    const KEY_REMEMBER_TOKEN = "rememberToken";

    const KEY_EFFECTIVE_MODE = "effectiveMode";      // staff | leader
    const KEY_EFFECTIVE_EMAIL = "effectiveEmail";    // email target impersonate
    const KEY_EFFECTIVE_NAME = "effectiveName";      // nama target (optional)

    let AUTH_USER = { email:"", role_akun:"Staff", divisi:"", nama:"" };
    let VIEW_USER = { email:"", nama:"", posisi:"", divisi:"", status_karyawan:"", role_akun:"" };

    let UI_STATE = { mode:"staff", divisi:"", personEmail:"", personName:"" };
    let LISTENERS_BOUND = false;

    function safeParse(m){
      if (typeof m === "object" && m) return m;
      try { return JSON.parse(m); } catch(e){ return null; }
    }
    function formatNumber(n){ return new Intl.NumberFormat('id-ID').format(n || 0); }
    function formatMoney(n){ return "Rp " + formatNumber(n || 0); }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function setMessage(t){ document.getElementById("msg").innerText = t || ""; }

    function goLogin(){
      window.top.location.href = APP_URL + "?page=login";
    }

    function requireLoginOrRedirect(){
      const url = new URL(window.location.href);
      const qEmail = (url.searchParams.get("email") || "").trim().toLowerCase();
      if (qEmail){
        sessionStorage.setItem(KEY_EMAIL, qEmail);
        return Promise.resolve(qEmail);
      }

      const sEmail = (sessionStorage.getItem(KEY_EMAIL) || "").trim().toLowerCase();
      if (sEmail) return Promise.resolve(sEmail);

      const token = (localStorage.getItem(KEY_REMEMBER_TOKEN) || "").trim();
      if (!token) return Promise.reject("no_token");

      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler((json) => {
            const res = safeParse(json);
            if (!res || !res.ok || !res.email){
              localStorage.removeItem(KEY_REMEMBER_TOKEN);
              reject("invalid_token");
              return;
            }
            sessionStorage.setItem(KEY_EMAIL, res.email);
            resolve(res.email);
          })
          .withFailureHandler(() => reject("fail"))
          .validateRememberToken(token);
      });
    }

    function logout(){
      sessionStorage.removeItem(KEY_EMAIL);
      localStorage.removeItem(KEY_REMEMBER_TOKEN);

      sessionStorage.removeItem(KEY_EFFECTIVE_MODE);
      sessionStorage.removeItem(KEY_EFFECTIVE_EMAIL);
      sessionStorage.removeItem(KEY_EFFECTIVE_NAME);

      goLogin();
    }

    function goPage(page){
      const email = (sessionStorage.getItem(KEY_EMAIL) || "").trim().toLowerCase();
      if (!email){ setMessage("Kamu belum login."); goLogin(); return; }
      window.top.location.href = APP_URL + "?page=" + encodeURIComponent(page) + "&email=" + encodeURIComponent(email);
    }

    function goHistoriPengerjaan(){
      goPage("histori");
    }

    /* =========================
       ROLE MODAL
       ========================= */
    function openRoleModal(){
      const back = document.getElementById("roleModalBack");
      back.classList.add("show");
      back.setAttribute("aria-hidden","false");

      const divSel = document.getElementById("impersonateDivisi");
      divSel.value = UI_STATE.divisi || (AUTH_USER.divisi || "");

      document.getElementById("impersonatePerson").value = UI_STATE.personEmail || "";

      refreshImpersonationCandidates();
      syncHint();
      syncPreview();
    }

    function closeRoleModal(){
      const back = document.getElementById("roleModalBack");
      back.classList.remove("show");
      back.setAttribute("aria-hidden","true");
    }

    function selectMode(mode){
      UI_STATE.mode = mode;

      document.querySelectorAll(".segBtn").forEach(btn => {
        const m = btn.getAttribute("data-mode");
        if (m === mode) btn.classList.add("active");
        else btn.classList.remove("active");
      });

      document.getElementById("impersonatePerson").value = "";
      UI_STATE.personEmail = "";
      UI_STATE.personName = "";

      refreshImpersonationCandidates();
      syncHint();
      syncPreview();
    }

    function syncHint(){
      const hint = document.getElementById("roleHint");
      const role = String(AUTH_USER.role_akun || "").toLowerCase();

      if (role === "leader"){
        hint.innerHTML =
          "<b>Kamu login sebagai Leader.</b><br/>" +
          "Kamu hanya bisa memilih <b>Login sebagai Staff</b> dalam divisi kamu.";
      } else if (role === "management"){
        hint.innerHTML =
          "<b>Kamu login sebagai Management.</b><br/>" +
          "Kamu bisa memilih <b>Login sebagai Staff</b> atau <b>Login sebagai Leader</b>.";
      } else {
        hint.innerHTML =
          "<b>Kamu login sebagai Staff.</b><br/>" +
          "Mode akses tidak bisa diganti.";
      }

      const divSel = document.getElementById("impersonateDivisi");
      if (role === "leader"){
        divSel.value = AUTH_USER.divisi || "";
        divSel.disabled = true;
      } else if (role === "management"){
        divSel.disabled = false;
      } else {
        divSel.disabled = true;
      }
    }

    function syncPreview(){
      const divSel = document.getElementById("impersonateDivisi");
      const personSel = document.getElementById("impersonatePerson");

      const div = divSel ? (divSel.value || "") : "";
      const personName = personSel ? (personSel.options[personSel.selectedIndex]?.text || "") : "";

      const modeLabel = UI_STATE.mode === "leader" ? "Login sebagai Leader" : "Login sebagai Staff";

      document.getElementById("previewMeta").innerText = `Mode: ${modeLabel}`;
      document.getElementById("previewRolePill").innerText = `Role: ${UI_STATE.mode === "leader" ? "Leader" : "Staff"}`;
      document.getElementById("previewDivisiPill").innerText = `Divisi: ${div || (AUTH_USER.divisi || "-")}`;

      document.getElementById("previewName").innerText =
        personName && !personName.startsWith("—") ? personName : "— pilih orang dulu —";
    }

    function resetImpersonationUI(){
      UI_STATE.mode = "staff";
      UI_STATE.personEmail = "";
      UI_STATE.personName = "";
      UI_STATE.divisi = AUTH_USER.divisi || "";

      sessionStorage.removeItem(KEY_EFFECTIVE_MODE);
      sessionStorage.removeItem(KEY_EFFECTIVE_EMAIL);
      sessionStorage.removeItem(KEY_EFFECTIVE_NAME);

      applyEffectiveRolePillLabel();
      closeRoleModal();

      applyHomeFilter(); // reload current filter w/ auth
    }

    function applyImpersonationUI(){
      const divSel = document.getElementById("impersonateDivisi");
      const personSel = document.getElementById("impersonatePerson");

      const div = divSel ? (divSel.value || "") : "";
      const personEmail = personSel ? (personSel.value || "") : "";
      const personName = personSel ? (personSel.options[personSel.selectedIndex]?.text || "") : "";

      if (!personEmail){
        setMessage("Pilih orang dulu sebelum menerapkan.");
        return;
      }

      UI_STATE.divisi = div;
      UI_STATE.personEmail = personEmail;
      UI_STATE.personName = (personName && !personName.startsWith("—")) ? personName : "";

      sessionStorage.setItem(KEY_EFFECTIVE_MODE, UI_STATE.mode);
      sessionStorage.setItem(KEY_EFFECTIVE_EMAIL, UI_STATE.personEmail);
      sessionStorage.setItem(KEY_EFFECTIVE_NAME, UI_STATE.personName || "");

      applyEffectiveRolePillLabel();
      closeRoleModal();

      applyHomeFilter(); // reload current filter w/ effective
    }

    function applyEffectiveRolePillLabel(){
      const rolePill = document.getElementById("loginRolePill");
      const mode = (sessionStorage.getItem(KEY_EFFECTIVE_MODE) || "");
      const effEmail = (sessionStorage.getItem(KEY_EFFECTIVE_EMAIL) || "").trim();

      if (mode && effEmail){
        rolePill.textContent = (mode === "leader") ? "Leader" : "Staff";
      } else {
        rolePill.textContent = AUTH_USER.role_akun || "Pengguna";
      }
    }

    function setupRolePillInteractivity(){
      const rolePill = document.getElementById("loginRolePill");
      const role = String(AUTH_USER.role_akun || "").trim().toLowerCase();

      rolePill.classList.add("pillDisabled");
      rolePill.onclick = null;

      if (role === "leader" || role === "management"){
        rolePill.classList.remove("pillDisabled");
        rolePill.onclick = () => {
          if (role === "leader"){
            document.getElementById("segLeader").style.display = "none";
            selectMode("staff");
          } else {
            document.getElementById("segLeader").style.display = "inline-flex";
            selectMode("staff");
          }

          syncHint();
          openRoleModal();
        };
      }
    }

    // isi kandidat dari backend
    // return: { ok:true, items:[{email,nama,divisi,role_akun}] }
    function refreshImpersonationCandidates(){
      const role = String(AUTH_USER.role_akun || "").toLowerCase();
      if (!(role === "leader" || role === "management")) return;

      const mode = UI_STATE.mode;
      const div = (document.getElementById("impersonateDivisi").value || "").trim();
      const personSel = document.getElementById("impersonatePerson");

      // reset options keep placeholder
      const first = personSel.options[0];
      personSel.innerHTML = "";
      personSel.appendChild(first);

      const addFallback = (msg) => {
        if (personSel.options.length <= 1){
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = msg || "— Tidak ada kandidat —";
          personSel.appendChild(opt);
        }
      };

      try{
        google.script.run
          .withSuccessHandler((json) => {
            const res = safeParse(json);
            if (!res || !res.ok || !Array.isArray(res.items)){
              addFallback("— Kandidat belum tersedia —");
              return;
            }
            if (res.items.length === 0){
              addFallback("— Tidak ada kandidat —");
              return;
            }
            res.items.forEach(it => {
              const opt = document.createElement("option");
              opt.value = String(it.email || "").trim().toLowerCase();
              opt.textContent = String(it.nama || it.email || "-");
              personSel.appendChild(opt);
            });
          })
          .withFailureHandler(() => addFallback("— Gagal load kandidat —"))
          .getImpersonationCandidates(AUTH_USER.email, mode, div);
      }catch(e){
        addFallback("— Kandidat belum tersedia —");
      }
    }

    /* =========================
       SETTERS (VIEW)
       ========================= */
    function setProfile(res){
      const nama = (res && res.namaMitra) ? String(res.namaMitra).trim() : "-";
      document.getElementById("namaMitra").innerText = nama || "-";

      const posisi = (res && res.posisi) ? String(res.posisi).trim() : "";
      const divisi = (res && res.divisi) ? String(res.divisi).trim() : "";
      const statusK = (res && res.status_karyawan) ? String(res.status_karyawan).trim() : "";
      const roleAkun = (res && res.role_akun) ? String(res.role_akun).trim() : "";

      document.getElementById("posisiPill").textContent = posisi || "-";
      document.getElementById("divisiVal").textContent = divisi || "-";
      document.getElementById("statusKaryawanVal").textContent = statusK || "-";

      VIEW_USER.nama = nama || "";
      VIEW_USER.posisi = posisi || "";
      VIEW_USER.divisi = divisi || "";
      VIEW_USER.status_karyawan = statusK || "";
      VIEW_USER.role_akun = roleAkun || "";
    }

    function setWork(res){
      document.getElementById("workAll").innerText = formatNumber(res.workAll || 0);
      document.getElementById("workDone").innerText = formatNumber(res.workDone || 0);
      document.getElementById("workNotDone").innerText = formatNumber(res.workNotDone || 0);
      document.getElementById("workDoneInvoiced").innerText = formatNumber(res.workDoneInvoiced || 0);
      document.getElementById("workDoneNotInvoiced").innerText = formatNumber(res.workDoneNotInvoiced || 0);
    }

    function setKomisi(res){
      document.getElementById("totalAll").innerText = formatMoney(res.totalAll || 0);
      document.getElementById("totalPaid").innerText = formatMoney(res.totalPaid || 0);
      document.getElementById("totalUnpaid").innerText = formatMoney(res.totalUnpaid || 0);
      document.getElementById("spkAll").innerText = `${res.spkAll || 0} SPK`;
      document.getElementById("spkPaid").innerText = `${res.spkPaid || 0} SPK`;
      document.getElementById("spkUnpaid").innerText = `${res.spkUnpaid || 0} SPK`;
    }

    function setNet(res){
      document.getElementById("netTotal").innerText = formatMoney(res.netTotal || 0);
      document.getElementById("netIncome").innerText = formatMoney(res.netIncome || 0);
      document.getElementById("netDeduction").innerText = formatMoney(res.netDeduction || 0);
    }

    function parseIsoDate(iso){
      if (!iso) return null;
      const d = new Date(iso + "T00:00:00");
      return isNaN(d.getTime()) ? null : d;
    }

    function monthsInclusive(fromIso, toIso){
      const fromD = parseIsoDate(fromIso);
      const toD = parseIsoDate(toIso);

      if (!fromD && !toD) return null;
      if (fromD && !toD) return 1;
      if (!fromD && toD) return 1;

      let a = fromD, b = toD;
      if (a > b){ const tmp = a; a = b; b = tmp; }

      const months = (b.getFullYear() - a.getFullYear()) * 12 + (b.getMonth() - a.getMonth()) + 1;
      return Math.max(1, months);
    }

    function setTarget(res, fromIso, toIso){
      const t = (res && res.target) ? res.target : { achieved:0, target:0, percent:0 };

      const m = monthsInclusive(fromIso, toIso);
      const computedTarget = (m === null) ? Number(t.target || 0) : (Number(m) * 100);

      const achieved = Number(t.achieved || 0);
      const target = Number(computedTarget || 0);
      const percent = target > 0 ? Math.round((achieved / target) * 100) : 0;

      const metaText = `${formatNumber(achieved)}/${formatNumber(target)} • ${formatNumber(percent)}%`;

      const bar = document.getElementById("barInner");
      const barTextTop = document.getElementById("barTextTop");

      const w = Math.max(0, Math.min(100, Number(percent||0)));
      bar.style.width = `${w}%`;

      barTextTop.innerText = metaText;
    }

    function renderRankingTable(tbodyId, items){
      const tb = document.getElementById(tbodyId);
      tb.innerHTML = "";

      if (!items || !items.length){
        tb.innerHTML = `<tr><td colspan="5">Belum ada data</td></tr>`;
        return;
      }

      items.forEach((it, idx) => {
        const tr = document.createElement("tr");
        if (it.isMe) tr.classList.add("meRow");
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${escapeHtml(it.name)}</td>
          <td>${escapeHtml(it.posisi || "-")}</td>
          <td>${formatMoney(it.total || 0)}</td>
          <td>${formatNumber(it.spkCount || 0)}</td>
        `;
        tb.appendChild(tr);
      });
    }

    // ✅ AMAN: selalu lewat auth+effective
    function loadViewSummary(authEmail, effectiveEmail, fromIso, toIso){
      setMessage("");

      google.script.run
        .withSuccessHandler((json) => {
          const res = safeParse(json);
          if (!res){ setMessage("Response tidak valid."); return; }
          if (!res.ok){ setMessage(res.message || "Gagal ambil ringkasan."); return; }

          setProfile(res);
          setWork(res);
          setKomisi(res);
          setNet(res);
          setTarget(res, fromIso || "", toIso || "");

          const r = res.rankings || {};
          renderRankingTable("tbodyAcross", (r.acrossDivisions || []));
          renderRankingTable("tbodyWithin", (r.withinDivision || []));
        })
        .withFailureHandler((err) => setMessage("Error: " + (err && err.message ? err.message : err)))
        .getHomepageSummaryByAuthEmailWithFilter(
          String(authEmail || "").trim().toLowerCase(),
          String(effectiveEmail || "").trim().toLowerCase(),
          fromIso || "",
          toIso || ""
        );
    }

    // ✅ init auth + load view (respect impersonation saved)
    function initAuthAndView(loginEmail){
      AUTH_USER.email = loginEmail || "";

      // ambil auth profile via summary biasa (self) lalu set pill interactivity
      google.script.run
        .withSuccessHandler((json) => {
          const res = safeParse(json);
          if (!res || !res.ok){
            setMessage((res && res.message) ? res.message : "Gagal load akun.");
            return;
          }

          AUTH_USER.role_akun = String(res.role_akun || "Staff");
          AUTH_USER.divisi = String(res.divisi || "");
          AUTH_USER.nama = String(res.namaMitra || "");

          setupRolePillInteractivity();

          document.getElementById("loginEmailPill").innerText = loginEmail || "-";

          const effEmail = (sessionStorage.getItem(KEY_EFFECTIVE_EMAIL) || "").trim().toLowerCase();
          const effMode = (sessionStorage.getItem(KEY_EFFECTIVE_MODE) || "").trim().toLowerCase();

          applyEffectiveRolePillLabel();

          const from = document.getElementById("dateFrom").value || "";
          const to = document.getElementById("dateTo").value || "";

          if (effEmail && (effMode === "staff" || effMode === "leader")){
            loadViewSummary(AUTH_USER.email, effEmail, from, to);
          } else {
            loadViewSummary(AUTH_USER.email, AUTH_USER.email, from, to);
          }

          bindModalListenersOnce();
        })
        .withFailureHandler((err) => setMessage("Error: " + (err && err.message ? err.message : err)))
        .getHomepageSummaryByEmailWithFilter(loginEmail, "", "");
    }

    function bindModalListenersOnce(){
      if (LISTENERS_BOUND) return;
      LISTENERS_BOUND = true;

      document.getElementById("impersonateDivisi").addEventListener("change", () => {
        UI_STATE.divisi = document.getElementById("impersonateDivisi").value || "";
        refreshImpersonationCandidates();
        syncPreview();
      });
      document.getElementById("impersonatePerson").addEventListener("change", () => {
        const personSel = document.getElementById("impersonatePerson");
        UI_STATE.personEmail = personSel.value || "";
        UI_STATE.personName = personSel.options[personSel.selectedIndex]?.text || "";
        syncPreview();
      });
    }

    function applyHomeFilter(){
      const from = document.getElementById("dateFrom").value || "";
      const to = document.getElementById("dateTo").value || "";

      const effEmail = (sessionStorage.getItem(KEY_EFFECTIVE_EMAIL) || "").trim().toLowerCase();
      const effMode = (sessionStorage.getItem(KEY_EFFECTIVE_MODE) || "").trim().toLowerCase();

      if (effEmail && (effMode === "staff" || effMode === "leader")){
        loadViewSummary(AUTH_USER.email, effEmail, from, to);
      } else {
        loadViewSummary(AUTH_USER.email, AUTH_USER.email, from, to);
      }
    }

    function resetHomeFilter(){
      document.getElementById("dateFrom").value = "";
      document.getElementById("dateTo").value = "";
      applyHomeFilter();
    }

    // close modal when click outside
    document.addEventListener("click", (e) => {
      const back = document.getElementById("roleModalBack");
      if (!back.classList.contains("show")) return;
      if (e.target === back) closeRoleModal();
    });

    (function init(){
      requireLoginOrRedirect()
        .then((email) => {
          document.getElementById("dateFrom").value = "";
          document.getElementById("dateTo").value = "";
          initAuthAndView(email);
        })
        .catch(() => goLogin());
    })();
  </script>
</body>
</html>
